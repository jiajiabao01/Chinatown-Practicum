---
title: "Feature Engineering Section"
author: "Sijia"
date: '2025-03-08'
output:
    html_document:
      code_folding: hide
---

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = FALSE, fig.show = "asis",
    fig.align = "center")
knitr::opts_knit$set(root.dir = "~/Documents/Upenn/Practicum/2025/results")

palette5 <- colorRampPalette(c("#1a9988", "#eb5600"))(5)
library(ggplot2)
library(tidyverse)
library(sf)
library(dplyr)
library(tidyr)
library(rlang)
library(patchwork)
```

### Data Set up
```text
1.  property_CT <- Property -  Chinatown scale - with FE
2.  property_final <- Property - Chinatown scale - without FE
2.  Third party: POIs (added in the property dataset)
```   
```{r Data set up, quiet = TRUE, results = 'hide'}
property_final <- st_read("~/Documents/Upenn/Practicum/2025/Chinatown-Practicum/DataWrangling/property_final.geojson") %>%
  st_transform('EPSG:2272')
```

### Features
```text
1. Log Distance to Restaurant
2. Log Distance to grocery
3. Features in Property Data
  a. Internal Features
    - interior condition 
    - number of bathrooms 
    - number of bedrooms 
    - separate_utilities 

  b. External Features
    - years built 
    - exterior condition 
    - quality grade 
    - central air 
    - garage spaces 
    - general condition 
    - building code description
    
  c. Spatial characteristics
    - depth
    - zoning 
    - distances related features
```

### Feature Engineering
```{r FE countinued}
property_CT <- property_final %>%
  mutate(
    year_built = as.numeric(year_built),
    year_built_group = case_when(
    year_built < 1990 ~ "Before 1990",
    year_built >= 1990 & year_built < 2000 ~ "1990-1999",
    year_built >= 2000 & year_built < 2020 ~ "2000s-2020s",
    year_built >= 2020 ~ "2020s+"),
    log_price = log(adj_sale_price),
    log_dist_highway = log(distance_to_I676 +1),
    
    central_air = case_when(
      central_air %in% c("1", "Y") ~ "Y",  
      TRUE ~ "N"                          
    ),
    central_air = factor(central_air),
    
    exterior_condition = case_when(
      is.na(exterior_condition) | exterior_condition == 1 ~ "1",    
      exterior_condition %in% c(2, 3) ~ "2",                        
      exterior_condition == 4 ~ "3",                                
      TRUE ~ "4"                      
    ),
    exterior_condition = factor(exterior_condition),
  
    interior_condition = case_when(
      interior_condition %in% c(0, 1, 2, 3) ~ "1",         
      interior_condition %in% c(4, NA) ~ "2",        
      TRUE ~ "3"       
    ),
    interior_condition = factor(interior_condition),
    
    garage_spaces = case_when(
      is.na(garage_spaces) | garage_spaces == 0 ~ "0",    
      garage_spaces == 1 ~ "1",      
      TRUE ~ "2"                     
    ),
    garage_spaces = factor(garage_spaces),
    
    general_construction = case_when(       
      general_construction %in% c("A ", "B ", "D ") ~ "A",  
      general_construction == "3 " ~ "C",        
      TRUE ~ "B"                                 
    ),
    general_construction = factor(general_construction),
    
    number_of_bathrooms = case_when(
      number_of_bathrooms == 0 ~ "0",                   
      number_of_bathrooms == 1 ~ "1",                   
      number_of_bathrooms %in% c(2, NA) ~ "2",          
      number_of_bathrooms == 3 ~ "3",                   
      TRUE ~ "4"                                        
    ),
    number_of_bathrooms = factor(number_of_bathrooms),
    
    number_of_bedrooms = case_when(
      number_of_bedrooms %in% c(0, 12) | is.na(number_of_bedrooms) ~ "0",  
      number_of_bedrooms %in% c(1, 2) ~ "1",    
      number_of_bedrooms == 3 ~ "2",            
      number_of_bedrooms == 4 ~ "3",            
      number_of_bedrooms %in% c(5, 6) ~ "4",    
      number_of_bedrooms %in% c(7, 8, 9) ~ "5" 
    ),
    number_of_bedrooms = factor(number_of_bedrooms),
    
    
    quality_grade = case_when(
      quality_grade %in% c("A+", "A", "A-", "X", "X-") ~ "1",           
      quality_grade %in% c("B+", "B", "B-", "3", "S+") ~ "2",
      TRUE ~ "3"                                             
    ),
    quality_grade = factor(quality_grade),
    
    separate_utilities = case_when(
      separate_utilities %in% c("A", "C") ~ "B",  
      TRUE ~ "A"                                 
    ),
    separate_utilities = factor(separate_utilities),
    
    
    building_code_description_new = case_when(
      building_code_description_new %in% c("COLONIAL", "OLD STYLE", "ROW MODERN", "ROW OLD STYLE", "TUDOR", "TWIN BUNGALOW") ~ "1",
      building_code_description_new %in% c("ROW POST WAR", "ROW TYPICAL", "TWIN CONVENTIONAL") ~ "3",
      building_code_description_new %in% c("OTHER", "ROW PORCH FRONT") ~ "4",
      TRUE ~ "2"
    ),
    building_code_description_new = factor(building_code_description_new),

    zoning_group = case_when(
    zoning %in% c("CMX5") ~ "CMX5",
    zoning %in% c("IRMX") ~ "IRMX",
    zoning %in% c("RM1","RM2", "RM4") ~ "RM",
    zoning %in% c("RMX3") ~ "RMX3",
    zoning %in% c("RSA5") ~ "RSA5",
    zoning %in% c("ICMX") ~ "ICMX",
    zoning %in% c("SPPOA") ~ "SPPOA",
    zoning %in% c("I2") ~ "I2",
    zoning %in% c("CMX2.5", "CMX2", "CMX1") ~ "Neighborhood Commercial",
    zoning %in% c("CMX3", "CMX4") ~ "Community Commercial",
    TRUE ~ "Other"),
  )

mean_depth <- mean(property_CT$depth, na.rm = TRUE)
property_CT$depth[is.na(property_CT$depth)] <- mean_depth

```

