---
title: "EDA - Aki"
author: "Luming Xu, Sijia Zhang, Aki Di Sandro, Ray Ma, Yixuan Zhou"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r r-setup, results='hide', echo = F, eval = T, warning = F, message = F}
knitr::opts_chunk$set(echo = T, eval = T, warning = F, message = F)

# set working directory
setwd("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/")

# load all packages
library(tidyverse)
library(tidycensus)
library(sf)
library(ggplot2)
library(kableExtra)
library(corrplot)
library(googleway)
library(RgoogleMaps)

# read in API
census_api_key("f2855a6037284cb9cbed55e96e6b99be17ee05c6", overwrite = TRUE, install = T)

# mapbox API
# options(rdeck.mapbox_access_token = "pk.eyJ1IjoiY2hpYmlha2kiLCJhIjoiY20xODh2NTNqMTBvaDJqb2ptbjM4ZGViayJ9.un9M1_-S6kI8M0ktqZLz_Q")

# google API
google_api <- colnames(read.delim("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/google_api_aki.txt"))

```

# Loading all data

```{r load_data}
# study area
# studyarea <- st_read("data/StudyArea.shp") %>% 
studyarea <- st_read("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/Dataset/studyarea/StudyArea.shp") %>%
  st_transform('EPSG:2272')

# Philly block groups
# blockgroups <- st_read("data/Philly_blockgroup.shp") %>%
blockgroups <- st_read("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/Dataset/Philly_blockgroup/Philly_blockgroup.shp") %>%
  st_transform('EPSG:2272')

# philly bounds
philly_bounds <- st_union(blockgroups)

# philly hydrology (bounded by philly_bounds; source: https://opendataphilly.org/datasets/hydrology/)
hydro <- st_read("https://services.arcgis.com/fLeGjb7u4uXqeF9q/arcgis/rest/services/Hydrographic_Features_Poly/FeatureServer/1/query?outFields=*&where=1%3D1&f=geojson") %>% 
    st_transform(crs = 'EPSG:2272') %>% 
  st_intersection(philly_bounds)

# highway
# stateroads_inphilly <- st_read("data/PaStateRoads2024_03.geojson") %>% 
#   st_transform('EPSG:2272') %>% 
#   st_intersection(philly_bounds)

# write out stateroads_inphilly as its own file since it's big
# st_write(stateroads_inphilly,
#          "data/PhillyStateRoads.shp")

# read in pre-filtered stateroads data
stateroads_inphilly <- st_read("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/data/PhillyStateRoads.shp")

philly_mainhighways <- stateroads_inphilly %>%
  filter(TRAF_RT_NO %in% c("I", "US"),
         ST_RT_NO %in% c("0001", "0095", "0076", "0676")) %>%
  dplyr::select(STREET_NAM, ST_RT_NO, TRAF_RT_NO, TRAF_RT__1)

# save and only use the highways of interest
# for now, interested in comparing highways that cut through neighborhoods vs those that don't

# ACS 


# philly property data (https://opendataphilly.org/datasets/philadelphia-properties-and-assessment-history/) <-- that was the original source, but now i'm using the same downloaded file that Luming and Sijia have been working from
# philly_properties <- st_read("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/data/opa_properties_public.geojson") %>% 
#   st_transform(crs = 'EPSG:2272')

# new property CSV
# this is a CSV and doesn't have the right geometry col
# philly_properties_new <- read_csv("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/data/property_philly_250307.csv") %>% 
#   rename(old_geom = geometry) %>% 
#   left_join(philly_properties %>% 
#               select(objectid, geometry), # joining with original properties data to get geometries
#             by = "objectid") %>% 
#   st_as_sf(crs = 'EPSG:2272')

# write out file as geojson
# st_write(philly_properties_new,
#          "~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/data/property_philly_250307.geojson")

# new property data (from 3/7/25 with inflation adjusted property prices)
philly_properties <- st_read("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/data/property_philly_250318.geojson")

# philly park data (https://opendataphilly.org/datasets/ppr-properties/)
philly_parks <- st_read("https://opendata.arcgis.com/datasets/d52445160ab14380a673e5849203eb64_0.geojson") %>%
  st_transform(crs = 'EPSG:2272') %>% 
  st_intersection(philly_bounds)

# philly schools
school <-
  st_read("https://opendata.arcgis.com/datasets/d46a7e59e2c246c891fbee778759717e_0.geojson") %>%
  st_transform('EPSG:2272')

# city facilities (https://opendataphilly.org/datasets/city-facilities-master-facilities-database/)
facilities <- st_read("https://opendata.arcgis.com/datasets/b3c133c3b15d4c96bcd4d5cc09f19f4e_0.geojson") %>%
  st_transform('EPSG:2272') %>% 
  filter(STATUS == "A") # remove inactive sites

# libraries (from facilities data)
libraries <- facilities %>% 
  filter(ASSET_GROUP1 == "A8")

# prisons (from facilities data)
prisons <- facilities %>% 
  filter(ASSET_GROUP2 == "A13.3")

# historic site (from facilities data)
historic <- facilities %>% 
  filter(ASSET_SUBTYPE1 == "C21")

# museums (from facilities data)
museums <- facilities %>% 
  filter(ASSET_GROUP1 == "A18",
         ASSET_SUBTYPE1 == "C35")

# produce (LPSS, HPSS -- indicators for produce; low or high produce supply stores)
retail_produce <- st_read("https://opendata.arcgis.com/datasets/53b8a1c653a74c92b2de23a5d7bf04a0_0.geojson") %>%
  st_transform('EPSG:2272')

# transit stops
metro <- st_read("https://opendata.arcgis.com/api/v3/datasets/af52d74b872045d0abb4a6bbbb249453_0/downloads/data?format=geojson&spatialRefId=4326") %>%
  st_transform('EPSG:2272') %>%
  mutate(Type = "metro")

city_hall <- metro[metro$Station == 'City Hall', 6]

trolley <- st_read("https://opendata.arcgis.com/api/v3/datasets/dd2afb618d804100867dfe0669383159_0/downloads/data?format=geojson&spatialRefId=4326") %>%
  st_transform('EPSG:2272')

# why are some trolley stations missing? going southwest from 40th st station + going northwest from 33rd/34th station

trolley_renamed <- trolley %>%
    rename(Station = StopName,
           Route = LineAbbr,
           Longitude = Lon,
           Latitude = Lat) %>%
    mutate(Type = "trolley")

# Combine both datasets into one
transit <- bind_rows(metro, trolley_renamed)

# PA hospitals (within 2.5 miles of philly bounds)
hospitals <- st_read("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/data/DOH_Hospitals202311.geojson") %>% 
  st_transform('EPSG:2272') %>% 
  st_intersection(st_buffer(philly_bounds, 13200))

# farmers markets
farmersmarkets <- st_read("https://opendata.arcgis.com/datasets/0707c1f31e2446e881d680b0a5ee54bc_0.geojson") %>% 
  st_transform('EPSG:2272')

# checking out what Luming_property.csv looks like
luming_property <- read.csv("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/Dataset/Luming_property.csv")
# looking at which properties were saved in luming_property -- Luming and Sijia's properties files are limited to the case study area
# luming_properties <- philly_properties %>% 
#   filter(objectid %in% luming_property$objectid)

# checking out what property_sijia_eda.geojson looks like
sijia_eda <- st_read("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/Dataset/property_sijia_eda.geojson")

# google API to get restaurant data
# incomplete, will figure this out later
# restaurant_results <- google_places(search_string = paste(search_terms, city, sep = " "), 
#                                     key = google_api)


```

# Initial plots

```{r plots_initial}
# interstate highways in philly
# ggplot() +
#     geom_sf(data = philly_bounds) +
#     geom_sf(data = stateroads_inphilly %>% 
#               filter(TRAF_RT_NO == "I"))
# 
# # US highways in philly
# ggplot() +
#     geom_sf(data = philly_bounds) +
#     geom_sf(data = stateroads_inphilly %>% 
#               filter(TRAF_RT_NO == "US"))
# 
# # PA state highways in philly
# ggplot() +
#     geom_sf(data = philly_bounds) +
#     geom_sf(data = stateroads_inphilly %>% 
#               filter(TRAF_RT_NO == "PA"))
# 
# # all other roads in philly
# ggplot() +
#     geom_sf(data = philly_bounds) +
#     geom_sf(data = stateroads_inphilly %>% 
#               filter(!(TRAF_RT_NO %in% c("I", "US", "PA"))))

# I-95, US-1, I-676, and I-76
philly_highways_plot <- 
  ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "#57470a") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = philly_mainhighways,
          aes(color = ST_RT_NO)) +
  # add custom colors
  scale_color_manual(values = c("0001" = "#1a9988",
                                "0076" = "#eb5600",
                                "0095" = "#eba075",
                                "0676" = "#7fe3d6"),
                     labels = c("US-1", "I-76", "I-95", "I-676")) +
  labs(title = "Case Study of Highways in Philly",
       subtitle = "US-1, I-76, I-95, and I-676",
       color = "Highways") +
  theme_void()
philly_highways_plot

# ggsave("Output/HighwaysMap.png", plot = philly_highways_plot)

# looking at study area within philly bounds
# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887") + 
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = studyarea, fill = "coral")

# philly parks
# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887") + 
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent")

# philly schools
# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887") + 
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = school, color = "brown4") # point data

# libraries
# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887") + 
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = libraries, color = "#eb5600") # point data

# transit / looking at what this category actually consists of....
# looks like there's point geography for parking lots, some random transit stops, and heli pad station
# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887") + 
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = facilities %>% 
#             filter(ASSET_GROUP1 == "A17",
#                    grepl("Parking", ASSET_SUBT1_DESC)), color = "pink") # point data

# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887") + 
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = sijia_eda, color = "#7fe3d6")

# prison facilities
# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887") + 
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = facilities %>% 
#             filter(ASSET_GROUP2 == "A13.3"), color = "lightgrey") # point data

# all philly properties
# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887") + 
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = philly_properties, color = "black")

```

# Case Study of Philadelphia's Highways and Housing Price

For all Philly properties, calculate the distance from highway and see how it relates to price.

```{r calc_dist_func}
# taking distance calculator function (from functions.R in PPA textbook)
calculate_nearest_distance <- function(set_points, other_layer) {
  nearest_idx <- st_nearest_feature(set_points, other_layer)
  st_distance(set_points, other_layer[nearest_idx, ], by_element = TRUE) %>% as.numeric()
}

```

The following code chunk took too much to load (too many properties to consider), so I'm going to limit it to the properties within 500m (and possibly look at 1000m and 1500m) from highways to look at the immediate effects of highways on property prices.

```{r highwaybuffer}
# only keep properties that are within 500m (1640.42 ft) of highways of interest
buff500 <- 500 * 3.28084
highways_500buffer <- st_union(st_buffer(philly_mainhighways, buff500))

properties500 <- philly_properties[highways_500buffer,]

# only keep properties that are within 1000m (3280.84 ft) of highways of interest
buff1000 <- 1000 * 3.28084
highways_1000buffer <- st_union(st_buffer(philly_mainhighways, buff1000))

properties1000 <- philly_properties[highways_1000buffer,]

```

## Properties within 500m of highways

```{r hghwybffr_plots}
# visualizing buffer
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "#57470a") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = highways_500buffer,
          color = "transparent", fill = "grey", alpha = 0.4) +
  geom_sf(data = philly_mainhighways,
          aes(color = ST_RT_NO)) +
  
  # add custom colors
  scale_color_manual(values = c("0001" = "#1a9988",
                                "0076" = "#eb5600",
                                "0095" = "#eba075",
                                "0676" = "#7fe3d6")) +
  
  labs(title = "Case Study of Highways in Philly",
       subtitle = "US-1, I-76, I-95, and I-676",
       color = "Highways",
       fill = "Highways") +
  theme_void()

# visualizing properties to make sure we got the right ones
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "#57470a") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = highways_500buffer,
          color = "transparent", fill = "grey", alpha = 0.4) +
  geom_sf(data = properties500,
          color = "#4a4a4a", size = .3) +
  geom_sf(data = philly_mainhighways,
          aes(color = ST_RT_NO)) +
  
  # add custom colors
  scale_color_manual(values = c("0001" = "#1a9988",
                                "0076" = "#eb5600",
                                "0095" = "#eba075",
                                "0676" = "#7fe3d6")) +
  
  labs(title = "Properties within 500m of Highways in Philly",
       subtitle = "US-1, I-76, I-95, and I-676",
       color = "Highways",
       fill = "Highways") +
  theme_void()

ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "#57470a") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = highways_1000buffer,
          color = "transparent", fill = "grey", alpha = 0.4) +
  geom_sf(data = properties1000,
          color = "#4a4a4a", size = .3) +
  geom_sf(data = philly_mainhighways,
          aes(color = ST_RT_NO)) +
  
  # add custom colors
  scale_color_manual(values = c("0001" = "#1a9988",
                                "0076" = "#eb5600",
                                "0095" = "#eba075",
                                "0676" = "#7fe3d6"),
                       labels = c("US-1", "I-76", "I-95", "I-676")) +
  
  labs(title = "Properties within 1000m of Highways in Philly",
       subtitle = "US-1, I-76, I-95, and I-676",
       color = "Highways",
       fill = "Highways") +
  theme_void()

```

```{r adj_sale_price}
# checking how infaltion-adjusted sale prices look compared to raw sale price
philly_properties %>% 
  select(sale_date, sale_price, adjusted_sale_price) %>% 
  st_drop_geometry() %>% 
  pivot_longer(cols = 2:3,
               names_to = "adj",
               values_to = "price") %>% 
  mutate(adj = factor(adj, levels = c("sale_price", "adjusted_sale_price"))) %>% 
  ggplot(aes(x = sale_date, y = price)) +
  geom_point() +
  facet_wrap(~adj) +
  labs(title = "Sale Price over Time") +
  theme_minimal()

# adjusted_sale_price vs sale_price, colored by sale_date
ggplot(philly_properties,
       aes(x = sale_price, y = adjusted_sale_price, color = sale_date)) +
    geom_point() +
    geom_smooth(method = "lm") +
  theme_minimal()
```
It looks like the inflation adjusted sales prices are a bit higher than the sales prices of 2024.

Are there differences between how price of property relates to dist_to_closest_highway depending on type of highway (whether highway cuts through neighborhood or not)?

```{r clean_prop500}
# starting with 500m buffer
# need to check if there are 0 values in sale_price before log transforming
summary(properties500$sale_price) # 16,430 rows
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
#    30345   166000   249900   461129   395000 15500000 

summary(properties500$adjusted_sale_price)
#    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
#   31569   190426   285105   529182   448071 19426645 

# using property data that has already been filtered
properties500_clean <- properties500 %>% 
  filter(total_area > 1) %>% # still keeping this filter for now
  mutate(price_perTLA = adjusted_sale_price / total_livable_area,
         price_perTA = adjusted_sale_price / total_area,
         log_price = log(adjusted_sale_price),
         log_price_perTLA = log(price_perTLA),
         log_price_perTA = log(price_perTA),
         category_easy = case_when(category_code_description %in% c("APARTMENTS  > 4 UNITS",
                                                                    "MIXED USE",
                                                                    "MULTI FAMILY",
                                                                    "SINGLE FAMILY") ~ "Residential or Mixed",
                                   grepl("INDUS", category_code_description) ~ "Industrial",
                                   grepl("HOTEL", category_code_description) ~ "Hotel",
                                   grepl("OFFICES", category_code_description) ~ "Offices",
                                   category_code_description %in% c("COMMERCIAL",
                                                                    "GARAGE - COMMERCIAL",
                                                                    "RETAIL") ~ "Commercial",
                                   grepl("VACANT", category_code_description) ~ "Vacant",
                                   .default = "Other"))

summary(properties500_clean$adjusted_sale_price) # 13,345 rows
#    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
#   31569   190426   285105   529182   448071 19426645 
summary(properties500_clean$price_perTLA)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's 
#  8.232 149.884 220.229     Inf 310.111     Inf     404 
summary(properties500_clean$price_perTA)
#   Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
#  1.179   109.486   175.165   386.567   405.577 11539.259

# correlations between total_area and total_livable_area, and sale_price
# cor(properties500_clean$total_area, properties500_clean$total_livable_area, use = "pairwise.complete.obs") # 0.5581733
# cor(properties500_clean$total_area, properties500_clean$sale_price, use = "pairwise.complete.obs") # 0.4357107
# cor(properties500_clean$total_livable_area, properties500_clean$sale_price, use = "pairwise.complete.obs") # 0.5772053

# histogram of sale_price
ggplot(data = properties500_clean) +
  geom_histogram(aes(x = adjusted_sale_price),
                 bins = 100) +
  theme_minimal() +
  labs(title = "Distribution of Adjusted Sale Price")

ggplot(data = properties500_clean) +
  geom_histogram(aes(x = price_perTA),
                 bins = 100) +
  theme_minimal() +
  labs(title = "Distribution of Sale Price per total area")

ggplot(data = properties500_clean) +
  geom_histogram(aes(x = price_perTLA),
                 bins = 100) +
  theme_minimal() +
  labs(title = "Distribution of Sale Price per total livable area")

ggplot(data = properties500_clean) +
  geom_histogram(aes(x = log_price),
                 bins = 100) +
  theme_minimal() +
  labs(title = "Distribution of Adjusted Sale Price (log-transformed)")

ggplot(data = properties500_clean) +
  geom_histogram(aes(x = log_price_perTA),
                 bins = 100) +
  theme_minimal() +
  labs(title = "Distribution of Sale Price per total area (log-transformed)")

ggplot(data = properties500_clean) +
  geom_histogram(aes(x = log_price_perTLA),
                 bins = 100) +
  theme_minimal() +
  labs(title = "Distribution of Sale Price per total livable area (log-transformed)")

```


```{r maps_prop500}
# map of properties within 500 m of highway, colored by sale_price
# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
#   geom_sf(data = highways_500buffer,
#           color = "transparent", fill = "grey", alpha = 0.4) +
#   geom_sf(data = properties500_clean,
#           aes(color = sale_price), size = .3) +
#   geom_sf(data = philly_mainhighways,
#           color = "black") +
#   labs(title = "Sale Price of Properties within 500m of Highways in Philly",
#        subtitle = "US-1, I-76, I-95, and I-676") +
#   theme_void()

# map of properties within 500 m of highway, colored by price_perTA
# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
#   geom_sf(data = highways_500buffer,
#           color = "transparent", fill = "grey", alpha = 0.4) +
#   geom_sf(data = properties500_clean,
#           aes(color = price_perTA), size = .3) +
#   geom_sf(data = philly_mainhighways,
#           color = "black") +
#   labs(title = "Sale Price (per Total Area) of Properties within 500m of Highways in Philly",
#        subtitle = "US-1, I-76, I-95, and I-676") +
#   theme_void()

# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
#   geom_sf(data = highways_500buffer,
#           color = "transparent", fill = "grey", alpha = 0.4) +
#   geom_sf(data = properties500_clean,
#           aes(color = price_perTLA), size = .3) +
#   geom_sf(data = philly_mainhighways,
#           color = "black") +
#   labs(title = "Sale Price (per Total Livable Area) of Properties within 500m of Highways in Philly",
#        subtitle = "US-1, I-76, I-95, and I-676") +
#   theme_void()

ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = highways_500buffer,
          color = "transparent", fill = "black", alpha = 0.2) +
  geom_sf(data = properties500_clean,
          aes(color = log_price), size = .3) +
  geom_sf(data = philly_mainhighways,
          color = "black") +
  labs(title = "Log Sale Price of Properties within 500m of Highways in Philly",
       subtitle = "US-1, I-76, I-95, and I-676",
       color = "Log Price") +
  theme_void()

# house sale price (category_easy == "Residential or Mixed")
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = highways_500buffer,
          color = "transparent", fill = "black", alpha = 0.2) +
  geom_sf(data = properties500_clean %>% 
            filter(grepl("Resident", category_easy)),
          aes(color = log_price), size = .3) +
  geom_sf(data = philly_mainhighways,
          color = "black") +
  labs(title = "Log Sale Price of Properties within 500m of Highways in Philly",
       subtitle = "Residential or Mixed Use properties only\nUS-1, I-76, I-95, and I-676",
       color = "Log Price") +
  theme_void()

ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = highways_500buffer,
          color = "transparent", fill = "grey", alpha = 0.4) +
  geom_sf(data = properties500_clean,
          aes(color = log_price_perTA), size = .3) +
  geom_sf(data = philly_mainhighways,
          color = "black") +
  labs(title = "Log Sale Price (per Total Area) of Properties within 500m of Highways in Philly",
       subtitle = "US-1, I-76, I-95, and I-676",
       color = "Log Price (per TA)") +
  theme_void()

# same thing but residential or mixed use only
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = highways_500buffer,
          color = "transparent", fill = "grey", alpha = 0.4) +
  geom_sf(data = properties500_clean %>% 
            filter(grepl("Resident", category_easy)),
          aes(color = log_price_perTA), size = .3) +
  geom_sf(data = philly_mainhighways,
          color = "black") +
  labs(title = "Log Sale Price (per Total Area) of Properties within 500m of Highways in Philly",
       subtitle = "Residential or Mixed Use properties only\nUS-1, I-76, I-95, and I-676",
       color = "Log Price (per TA)") +
  theme_void()

ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = highways_500buffer,
          color = "transparent", fill = "grey", alpha = 0.4) +
  geom_sf(data = properties500_clean,
          aes(color = log_price_perTLA), size = .3) +
  geom_sf(data = philly_mainhighways,
          color = "black") +
  labs(title = "Log Sale Price (per Total Livable Area) of Properties within 500m of Highways in Philly",
       subtitle = "US-1, I-76, I-95, and I-676",
       color = "Log Price (per TLA)") +
  theme_void()

# same thing but residential/mixed use only
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = highways_500buffer,
          color = "transparent", fill = "grey", alpha = 0.4) +
  geom_sf(data = properties500_clean %>% 
            filter(grepl("Resident", category_easy)),
          aes(color = log_price_perTLA), size = .3) +
  geom_sf(data = philly_mainhighways,
          color = "black") +
  labs(title = "Log Sale Price (per Total Livable Area) of Properties within 500m of Highways in Philly",
       subtitle = "Residential or Mixed Use properties only\nUS-1, I-76, I-95, and I-676",
       color = "Log Price (per TLA)") +
  theme_void()

```

Calculate each property's distance to highways.

```{r calc_dist2highway}
# calculate each property's distance to highways of interest
# distance is in feet
# start_time <- Sys.time()
# prop500 <- properties500_clean %>%
#   select(matches("assessment_date|building_code|category_|census_tract|geographic|zip|market_value|parcel|sale_|taxable|_area|year_built|objectid|geometry|price")) %>%
#   mutate(dist_to_US001 = calculate_nearest_distance(geometry,
#                                      philly_mainhighways %>%
#                                        filter(ST_RT_NO == "0001")),
#          dist_to_I076 = calculate_nearest_distance(geometry,
#                                     philly_mainhighways %>%
#                                       filter(ST_RT_NO == "0076")),
#          dist_to_I095 = calculate_nearest_distance(geometry,
#                                     philly_mainhighways %>%
#                                       filter(ST_RT_NO == "0095")),
#          dist_to_I676 = calculate_nearest_distance(geometry,
#                                     philly_mainhighways %>%
#                                       filter(ST_RT_NO == "0676")),
#          dist_to_US001m = dist_to_US001 * 0.3048,
#          dist_to_I076m = dist_to_I076 * 0.3048,
#          dist_to_I095m = dist_to_I095 * 0.3048,
#          dist_to_I676m = dist_to_I676 * 0.3048) # Time difference of 55.20697 secs

# find closest highway
# prop500_closest <- prop500 %>%
#   select(matches("objectid|dist_to")) %>%
#   pivot_longer(cols = 2:5,
#                names_to = "highway",
#                values_to = "distance") %>%
#   group_by(objectid) %>%
#   summarise(dist_to_closest_highway = min(distance, na.rm = T)) %>%
#   ungroup()  %>%
#   mutate(dist_to_closest_highwaym = dist_to_closest_highway * 0.3048)

# join closest highway
# prop500 <- left_join(prop500,
#                      prop500_closest %>% st_drop_geometry(),
#                      by = "objectid") %>%
#   mutate(closest_highway = case_when(
#     dist_to_closest_highway == dist_to_US001 ~ "US-1",
#     dist_to_closest_highway == dist_to_I076 ~ "I-76",
#     dist_to_closest_highway == dist_to_I095 ~ "I-95",
#     dist_to_closest_highway == dist_to_I676 ~ "I-676",
#     .default = NA),
#     closest_highway = factor(closest_highway, levels = c("US-1", "I-76", "I-676", "I-95")),
#     highway_type = case_when(closest_highway %in% c("US-1","I-676") ~ "through neighborhood",
#                              closest_highway %in% c("I-95","I-76") ~ "along waterway",
#                              .default = NA))

# save file
# st_write(prop500, "~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/data/philly_prop500_dst2hghwy_250318.geojson")

# read in pre-saved file
prop500 <- st_read("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/data/philly_prop500_dst2hghwy_250318.geojson") %>% 
  mutate(closest_highway = factor(closest_highway, levels = c("US-1", "I-76", "I-676", "I-95")))

```

First, let's looks at a faceted plot of the distribution of sales price for each highway separately

```{r prop500_faceted_distr}
# prop500_faceted <- 
#   ggplot(data = prop500,
#          aes(x = dist_to_closest_highwaym, y = log_price_perTA)) +
#   geom_point(color = "#1a9988", alpha = .1, size = 0.3) +
#   geom_smooth(color = "#eb5600", method = "lm", se = F, linewidth = 1.2) +
#   # geom_point(alpha = .1, size = 0.3) +
#   # geom_smooth(method = "lm", se = F, linewidth = 1.2) +
#   facet_wrap(~closest_highway) +
#   labs(title = "Distribution of Property Sale Price",
#        x = "Distance to Closest Highway (m)",
#        y = "Log Sale Price (per TA)") +
#   theme_minimal()

prop500_faceted <- 
  ggplot(data = prop500,
         aes(x = log_price_perTA, color = closest_highway, fill = closest_highway)) +
  geom_histogram(bins = 50) +
  facet_wrap(~closest_highway, scales = "free_y") +
  scale_color_manual(values = c("US-1" = "#1a9988",
                                "I-76" = "#eb5600",
                                "I-95" = "#eba075",
                                "I-676" = "#7fe3d6")) +
  scale_fill_manual(values = c("US-1" = "#1a9988",
                               "I-76" = "#eb5600",
                               "I-95" = "#eba075",
                               "I-676" = "#7fe3d6")) +
  labs(title = "Distribution of Property Sale Price",
       x = "Log Sale Price (per Total Area)",
       y = "Count",
       color = "Closest Highway",
       fill = "Closest Highway") +
  theme_minimal()

prop500_faceted

# save image for slides
# ggsave("Output/SalePriceDistribution.png", plot = prop500_faceted)

# residential + mixed only 
# prop500_faceted_res <- 
#   ggplot(data = prop500 %>% 
#            filter(grepl("Reside", category_easy)),
#          aes(x = dist_to_closest_highwaym, y = log_price_perTA)) +
#   geom_point(color = "#1a9988", alpha = .1, size = 0.3) +
#   geom_smooth(color = "#eb5600", method = "lm", se = F, linewidth = 1.2) +
#   # geom_point(alpha = .1, size = 0.3) +
#   # geom_smooth(method = "lm", se = F, linewidth = 1.2) +
#   # facet_wrap(closest_highway) +
#   labs(title = "Distribution of Property Sale Price",
#        x = "Distance to Closest Highway (m)",
#        y = "Log Sale Price (per TA)") +
#   theme_minimal()

prop500_faceted_res <- 
  ggplot(data = prop500 %>% 
           filter(grepl("Resid", category_easy)),
         aes(x = log_price_perTA, color = closest_highway, fill = closest_highway)) +
  geom_histogram(bins = 50) +
  facet_wrap(~closest_highway, scales = "free_y") +
  scale_color_manual(values = c("US-1" = "#1a9988",
                                "I-76" = "#eb5600",
                                "I-95" = "#eba075",
                                "I-676" = "#7fe3d6")) +
  scale_fill_manual(values = c("US-1" = "#1a9988",
                               "I-76" = "#eb5600",
                               "I-95" = "#eba075",
                               "I-676" = "#7fe3d6")) +
  labs(title = "Distribution of Property Sale Price",
       subtitle = "Residential and Mixed Properties only",
       x = "Log Sale Price (per Total Area)",
       y = "Count",
       color = "Closest Highway",
       fill = "Closest Highway") +
  theme_minimal()

prop500_faceted_res

# save image for slides
# ggsave("Output/SalePriceDistribution_residential.png", plot = prop500_faceted_res)

```

Now, look at relationship between distance to highway and price.

```{r price_dist2highway}
# map of properties within 500m of highway cored by which highway they're closest to
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = highways_500buffer,
          color = "transparent", fill = "grey", alpha = 0.4) +
  geom_sf(data = prop500,
          aes(color = closest_highway), size = 0.3) +
  geom_sf(data = philly_mainhighways,
          color = "black") +
  
  # add custom colors
  scale_color_manual(values = c("US-1" = "#1a9988",
                                "I-76" = "#eb5600",
                                "I-95" = "#eba075",
                                "I-676" = "#7fe3d6")) +
  
  labs(title = "Properties within 500m of Highways in Philly",
       subtitle = "US-1, I-76, I-95, and I-676",
       color = "Closest Highway") +
  theme_void()

# simple scatter of price and dist2closesthighway
ggplot(data = prop500, 
       aes(x = dist_to_closest_highwaym, y = adjusted_sale_price, 
           color = closest_highway, fill = closest_highway)) +
  geom_point(alpha = .2) +
  geom_smooth(method = "lm") +
  scale_color_manual(values = c("US-1" = "#1a9988",
                                "I-76" = "#eb5600",
                                "I-95" = "#eba075",
                                "I-676" = "#7fe3d6")) +
  scale_fill_manual(values = c("US-1" = "#1a9988",
                               "I-76" = "#eb5600",
                               "I-95" = "#eba075",
                               "I-676" = "#7fe3d6")) +
  labs(title = "Property Price as a function of Distance to Closest Highway",
       subtitle = "Properties within 500m of highways",
       fill = "Closest Highway",
       color = "Closest Highway",
       x = "Distance to Closest Highway (m)",
       y = "Property Sale Price ($)") +
  theme_minimal()

# simple scatter of price (as log price per total area in sq ft) and dist2closesthighway
cor_us1 <- round(cor(prop500 %>% 
                 filter(grepl("US", closest_highway)) %>% 
                 pull(log_price_perTA), 
               prop500 %>% 
                 filter(grepl("US", closest_highway)) %>% 
                 pull(dist_to_closest_highwaym)), 3)
cor_i76 <- round(cor(prop500 %>% 
                 filter(grepl("I-76", closest_highway)) %>% 
                 pull(log_price_perTA), 
               prop500 %>% 
                 filter(grepl("I-76", closest_highway)) %>% 
                 pull(dist_to_closest_highwaym)), 3)
cor_i95 <- round(cor(prop500 %>% 
                 filter(grepl("I-95", closest_highway)) %>% 
                 pull(log_price_perTA), 
               prop500 %>% 
                 filter(grepl("I-95", closest_highway)) %>% 
                 pull(dist_to_closest_highwaym)), 3)
cor_i676 <- round(cor(prop500 %>% 
                  filter(grepl("I-676", closest_highway)) %>% 
                  pull(log_price_perTA), 
                prop500 %>% 
                  filter(grepl("I-676", closest_highway)) %>% 
                  pull(dist_to_closest_highwaym)), 3)

scatter_4highways <- 
  ggplot(data = prop500, 
       aes(x = dist_to_closest_highwaym, y = log_price_perTA, 
           color = closest_highway, fill = closest_highway)) +
  geom_point(alpha = .2, size = 0.3) +
  geom_smooth(method = "lm", size = 1.2) +
  scale_color_manual(values = c("US-1" = "#1a9988",
                                "I-76" = "#eb5600",
                                "I-95" = "#eba075",
                                "I-676" = "#7fe3d6")) +
  scale_fill_manual(values = c("US-1" = "#1a9988",
                               "I-76" = "#eb5600",
                               "I-95" = "#eba075",
                               "I-676" = "#7fe3d6")) +
  geom_text(aes(label = cor_us1,
                x = 150,
                y = 1.25),
            color = "#1a9988",
            show.legend = F) +
  geom_text(aes(label = cor_i76,
                x = 350,
                y = 1.25),
            color = "#eb5600",
            show.legend = F) +
  geom_text(aes(label = cor_i95,
                x = 350,
                y = 8.75),
            color = "#eba075",
            show.legend = F) +
  geom_text(aes(label = cor_i676,
                x = 150,
                y = 8.75),
            color = "#7fe3d6",
            show.legend = F) +
  labs(title = "Property Price (log price per TA) as a function of Distance to Closest Highway",
       subtitle = "Properties within 500m of highways",
       fill = "Closest Highway",
       color = "Closest Highway",
       x = "Distance to Closest Highway (m)",
       y = "Property Sale Price (log price per TA)") +
  theme_minimal()

scatter_4highways

# save image for slides
# ggsave("Output/PriceVSDist2Highway_4highways.png",
#        plot = scatter_4highways,
#        height = 7,
#        width = 10)

# simple scatter of price (as log price per total area in sq ft) and dist2closesthighway 
# sale_price <= 1e7
ggplot(data = prop500 %>% 
         filter(sale_price <= 1e7), 
       aes(x = dist_to_closest_highwaym, y = log_price_perTA, 
           color = closest_highway, fill = closest_highway)) +
  geom_point(alpha = .2, size = 0.3) +
  geom_smooth(method = "lm", size = 1.2) +
  scale_color_manual(values = c("US-1" = "#1a9988",
                                "I-76" = "#eb5600",
                                "I-95" = "#eba075",
                                "I-676" = "#7fe3d6")) +
  scale_fill_manual(values = c("US-1" = "#1a9988",
                               "I-76" = "#eb5600",
                               "I-95" = "#eba075",
                               "I-676" = "#7fe3d6")) +
  labs(title = "Property Price (log price per TA) as a function of Distance to Closest Highway",
       subtitle = "Properties within 500m of highways",
       fill = "Closest Highway",
       color = "Closest Highway",
       x = "Distance to Closest Highway (m)",
       y = "Property Sale Price (log price per TA)") +
  theme_minimal()

# simple scatter of price (as log price per total area in sq ft) and log(dist2closesthighway)
ggplot(data = prop500, 
       aes(x = log(dist_to_closest_highwaym), y = log_price_perTA, 
           color = closest_highway, fill = closest_highway)) +
  geom_point(alpha = .2, size = 0.3) +
  geom_smooth(method = "lm", size = 1.2) +
  scale_color_manual(values = c("US-1" = "#1a9988",
                                "I-76" = "#eb5600",
                                "I-95" = "#eba075",
                                "I-676" = "#7fe3d6")) +
  scale_fill_manual(values = c("US-1" = "#1a9988",
                               "I-76" = "#eb5600",
                               "I-95" = "#eba075",
                               "I-676" = "#7fe3d6")) +
  labs(title = "Property Price (log price per TA) as a function of Distance to Closest Highway (log)",
       subtitle = "Properties within 500m of highways",
       fill = "Closest Highway",
       color = "Closest Highway",
       x = "Log Distance to Closest Highway (m)",
       y = "Log Property Sale Price (per TA)") +
  theme_minimal()

```

```{r prop500_regression}
# simple regression of price (log_price_perTA) and dist2closesthighway
fit1 <- lm(log_price_perTA ~ dist_to_closest_highwaym, data = prop500)

summary(fit1)

# multiple regression of price (log_price_perTA) and dist2closesthighway but adding highway type (4 types)
fit2 <- lm(log_price_perTA ~ dist_to_closest_highwaym + closest_highway, data = prop500)

summary(fit2)

# multiple regression of price (log_price_perTA) and dist2closesthighway but adding highway type (4 types) with interaction
fit3 <- lm(log_price_perTA ~ dist_to_closest_highwaym + closest_highway + dist_to_closest_highwaym*closest_highway, data = prop500)

summary(fit3)

# multiple regression of price (log_price_perTA) and dist2closesthighway but adding highway type (2 types)
fit4 <- lm(log_price_perTA ~ dist_to_closest_highwaym + highway_type, data = prop500)

summary(fit4)

# multiple regression of price (log_price_perTA) and dist2closesthighway but adding highway type (2 types) with interaction
fit5 <- lm(log_price_perTA ~ dist_to_closest_highwaym + highway_type + dist_to_closest_highwaym*highway_type, data = prop500)

sum5 <- summary(fit5)

data.frame(sum5$coefficients) %>% 
  mutate(Estimate = round(Estimate, 3),
         StdErorr = round(Std..Error, 3),
         PValue = round(Pr...t.., 3)) %>% 
  select(Estimate, StdErorr, PValue) %>% 
  kbl(align = c("l", rep("c", 3)),
      caption = "Linear Regression: Sale Price ~ Distance to Closest Highway + Highway Type + Interaction") %>% 
    kable_styling() %>% 
    kable_classic(full_width = F, html_font = "Cambria") 


# multiple regression of price (log_price_perTA) and dist2closesthighway but adding highway type (2 types) with interaction
fit6 <- lm(log_price_perTA ~ log(dist_to_closest_highwaym) + highway_type + log(dist_to_closest_highwaym)*highway_type, data = prop500)

summary(fit6)

```


Visualizing the highway types (cutting through neighborhoods vs running alongside water).
```{r price_dist2highway_2types}
# simple scatter of price and dist2closesthighway
ggplot(data = prop500, 
       aes(x = dist_to_closest_highwaym, y = adjusted_sale_price, 
           color = highway_type, fill = highway_type)) +
  geom_point(alpha = .2, size = 0.3) +
  geom_smooth(method = "lm") +
  scale_color_manual(values = c("through neighborhood" = "#1a9988",
                                "along waterway" = "#eb5600")) +
  scale_fill_manual(values = c("through neighborhood" = "#1a9988",
                               "along waterway" = "#eb5600")) +
  labs(title = "Property Price as a function of Distance to Highway Type",
       subtitle = "Properties within 500m of highways",
       fill = "Highway Type",
       color = "Highway Type") +
  theme_minimal()

# simple scatter of price and dist2closesthighway with loess method
ggplot(data = prop500, 
       aes(x = dist_to_closest_highwaym, y = sale_price, 
           color = highway_type, fill = highway_type)) +
  geom_point(alpha = .2, size = 0.3) +
  geom_smooth(method = "loess", se = FALSE, size = 1.2) +
  scale_color_manual(values = c("through neighborhood" = "#1a9988",
                                "along waterway" = "#eb5600")) +
  scale_fill_manual(values = c("through neighborhood" = "#1a9988",
                               "along waterway" = "#eb5600")) +
  labs(title = "Property Price as a function of Distance to Highway Type",
       subtitle = "Properties within 500m of highways",
       fill = "Highway Type",
       color = "Highway Type") +
  theme_minimal()

# simple scatter of price (as log price per total area in sq ft) and dist2closesthighway
cor_thru <- round(cor(prop500 %>%
                        filter(grepl("through", highway_type)) %>% 
                        pull(log_price_perTA), 
                      prop500 %>% 
                        filter(grepl("through", highway_type)) %>% 
                        pull(dist_to_closest_highwaym)), 3)
cor_water <- round(cor(prop500 %>% 
                         filter(grepl("along", highway_type)) %>% 
                         pull(log_price_perTA), 
                       prop500 %>% 
                         filter(grepl("along", highway_type)) %>% 
                         pull(dist_to_closest_highwaym)), 3)

scatter_2types <- 
  ggplot(data = prop500, 
       aes(x = dist_to_closest_highwaym, y = log_price_perTA, 
           color = highway_type, fill = highway_type)) +
  geom_point(alpha = .2, size = 0.3) +
  geom_smooth(method = "lm", size = 1.2) +
  scale_color_manual(values = c("through neighborhood" = "#1a9988",
                                "along waterway" = "#eb5600")) +
  scale_fill_manual(values = c("through neighborhood" = "#1a9988",
                               "along waterway" = "#eb5600")) +
  geom_text(aes(label = cor_thru,
                x = 250,
                y = 1),
            color = "#1a9988",
            show.legend = F) +
  geom_text(aes(label = cor_water,
                x = 250,
                y = 9),
            color = "#eb5600",
            show.legend = F) +
  labs(title = "Property Price (log price per TA) as a function of Distance to Highway Type",
       subtitle = "Properties within 500m of highways",
       fill = "Highway Type",
       color = "Highway Type",
       x = "Distance to Closest Highway (m)",
       y = "Log Sale Price (per TA)") +
  theme_minimal()
scatter_2types

# save for slides
# ggsave("Output/PriceVSDist2Highway_2types.png", 
#        plot = scatter_2types,
#        height = 7,
#        width = 10)

# simple scatter of price (as log price per total area in sq ft) and dist2closesthighway
ggplot(data = prop500, 
       aes(x = log(dist_to_closest_highwaym), y = log_price_perTA, 
           color = highway_type, fill = highway_type)) +
  geom_point(alpha = .2, size = 0.3) +
  geom_smooth(method = "lm", size = 1.2) +
  scale_color_manual(values = c("through neighborhood" = "#1a9988",
                                "along waterway" = "#eb5600")) +
  scale_fill_manual(values = c("through neighborhood" = "#1a9988",
                               "along waterway" = "#eb5600")) +
  labs(title = "Property Price (log price per TA) as a function of Distance to Highway Type",
       subtitle = "Properties within 500m of highways",
       fill = "Highway Type",
       color = "Highway Type",
       x = "Distance to Closest Highway (m)",
       y = "Log Sale Price (per TA)") +
  theme_minimal()

# correlations
prop500 %>%
  st_drop_geometry() %>%
  group_by(highway_type) %>%
  summarize(correlation = cor(dist_to_closest_highwaym, log_price_perTA, method = "pearson"), .groups = "drop") %>% 
  mutate(correlation = round(correlation, 3)) %>% 
  kbl(col.names = c("Highway Type", "Correlation"),
        align = c("l", "c"),
      caption = "Correlation Between Property Sale Price and Distance to Closest Highway by Highway Types") %>% 
    kable_styling() %>% 
    kable_classic(full_width = F, html_font = "Cambria") 

# correlation of price and dist to highway for each highway
prop500 %>%
  st_drop_geometry() %>%
  group_by(closest_highway) %>%
  summarize(correlation = cor(dist_to_closest_highwaym, log_price_perTA, method = "pearson"), .groups = "drop") %>% 
  mutate(correlation = round(correlation, 3)) %>% 
  kbl(col.names = c("Highway", "Correlation"),
        align = c("l", "c"),
      caption = "Correlation Between Property Sale Price and Distance to Closest Highway by Highway") %>%
  kable_styling() %>% 
  kable_classic(html_font = "Cambria") 

prop500 %>%
  st_drop_geometry() %>%
  group_by(closest_highway) %>%
  summarize(correlation = cor(log(dist_to_closest_highwaym), log_price_perTA, method = "pearson"), .groups = "drop")

```

### Multiple Linear Regression: Sale Price by Distance to Highway (controlling for other variables)

We're looking at all properties in Philadelphia (sale date within the last 5 years, aka between Jan. 1st, 2020 - Dec.31st, 2024; sale price is < \$30,000 and > 5 SD from the mean sale price; total area is < 100 sq. ft.; inflation-adjusted prices).

I'm using log_price = log(adjusted_sale_price) as the outcome variable and including internal features, amenities, and fixed effects in addition to distance to highway.

```{r cleaning_properties}
# takes about 7 min to run
# cleaned_properties <- philly_properties %>%
#   mutate(price_perTLA = sale_price / total_livable_area,
#          price_perTA = sale_price / total_area,
#          log_price = log(sale_price),
#          log_price_perTLA = log(price_perTLA),
#          log_price_perTA = log(price_perTA),
#          category_easy = case_when(category_code_description %in% c("APARTMENTS  > 4 UNITS",
#                                                                     "MIXED USE",
#                                                                     "MULTI FAMILY",
#                                                                     "SINGLE FAMILY") ~ "Residential or Mixed",
#                                    grepl("INDUS", category_code_description) ~ "Industrial",
#                                    grepl("HOTEL", category_code_description) ~ "Hotel",
#                                    grepl("OFFICES", category_code_description) ~ "Offices",
#                                    category_code_description %in% c("COMMERCIAL",
#                                                                     "GARAGE - COMMERCIAL",
#                                                                     "RETAIL") ~ "Commercial",
#                                    grepl("VACANT", category_code_description) ~ "Vacant",
#                                    .default = "Other"),
#          dist_to_US001 = calculate_nearest_distance(geometry,
#                                      philly_mainhighways %>%
#                                        filter(ST_RT_NO == "0001")),
#          dist_to_I076 = calculate_nearest_distance(geometry,
#                                     philly_mainhighways %>%
#                                       filter(ST_RT_NO == "0076")),
#          dist_to_I095 = calculate_nearest_distance(geometry,
#                                     philly_mainhighways %>%
#                                       filter(ST_RT_NO == "0095")),
#          dist_to_I676 = calculate_nearest_distance(geometry,
#                                     philly_mainhighways %>%
#                                       filter(ST_RT_NO == "0676")),
#          dist_park = calculate_nearest_distance(geometry,
#                                                 philly_parks),
#          dist_lib = calculate_nearest_distance(geometry,
#                                                libraries),
#          dist_transit = calculate_nearest_distance(geometry,
#                                                    transit),
#          dist_school = calculate_nearest_distance(geometry,
#                                                   school),
#          dist_cityhall = calculate_nearest_distance(geometry,
#                                                     city_hall),
#          dist_hospital = calculate_nearest_distance(geometry,
#                                                     hospitals),
#          dist_museum = calculate_nearest_distance(geometry,
#                                                   museums),
#          dist_prison = calculate_nearest_distance(geometry,
#                                                   prisons),
#          dist_historic = calculate_nearest_distance(geometry,
#                                                     historic),
#          dist_to_US001m = dist_to_US001 * 0.3048,
#          dist_to_I076m = dist_to_I076 * 0.3048,
#          dist_to_I095m = dist_to_I095 * 0.3048,
#          dist_to_I676m = dist_to_I676 * 0.3048,
#          dist_parkm = dist_park * 0.3048,
#          dist_libm = dist_lib * 0.3048,
#          dist_transitm = dist_transit * 0.3048,
#          dist_schoolm = dist_school * 0.3048,
#          dist_cityhallm = dist_cityhall * 0.3048,
#          dist_hospitalm = dist_hospital * 0.3048,
#          dist_museumm = dist_museum * 0.3048,
#          dist_prisonm = dist_prison * 0.3048,
#          dist_historicm = dist_historic * 0.3048)

# find closest highway
# clean_closest <- cleaned_properties %>%
#   select(matches("objectid|dist_to_US|dist_to_I")) %>%
#   pivot_longer(cols = 2:5,
#                names_to = "highway",
#                values_to = "distance") %>%
#   group_by(objectid) %>%
#   summarise(dist_to_closest_highway = min(distance, na.rm = T)) %>%
#   ungroup()  %>%
#   mutate(dist_to_closest_highwaym = dist_to_closest_highway * 0.3048)

# join closest highway
# cleaned_props <- left_join(cleaned_properties,
#                            clean_closest %>% st_drop_geometry(),
#                            by = "objectid") %>%
#   mutate(closest_highway = case_when(
#     dist_to_closest_highway == dist_to_US001 ~ "US-1",
#     dist_to_closest_highway == dist_to_I076 ~ "I-76",
#     dist_to_closest_highway == dist_to_I095 ~ "I-95",
#     dist_to_closest_highway == dist_to_I676 ~ "I-676",
#     .default = NA),
#     closest_highway = factor(closest_highway, levels = c("US-1", "I-76", "I-676", "I-95")),
#     highway_type = case_when(closest_highway %in% c("US-1","I-676") ~ "through neighborhood",
#                              closest_highway %in% c("I-95","I-76") ~ "along waterway",
#                              .default = NA)) %>%
#   filter(!is.na(closest_highway))

# save for easier access later
# st_write(cleaned_props,
#          "~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/data/philly_cleaned_properties_with_amenities_250318.geojson")

# read in pre-saved data
cleaned_props <- st_read("~/Documents/MUSA/Spring25/MUSA8010_Practicum/Chinatown/data/philly_cleaned_properties_with_amenities.geojson") %>% 
  mutate(year_built = as.numeric(year_built))

```

Looking at correlation matrix of internal characteristics.

```{r internal_cormat}

```


```{r prop_mult_reg}
# model with no interactions
mult_reg <- lm(log_price ~ dist_to_closest_highwaym + 
                 total_area + year_built + # internal characteristics
                 dist_parkm + dist_libm + dist_cityhallm + dist_hospitalm + dist_historicm + # external / amenities
                 factor(zip_code), # neighborhood effects (via zip code for now)
               data = cleaned_props)

summary(mult_reg)

# model with interaction between dist to closest highway and ZIP
mult_reg_int <- lm(log_price ~ dist_to_closest_highwaym * factor(zip_code) + 
                     total_area + year_built + # internal characteristics
                     dist_parkm + dist_libm + dist_cityhallm + dist_hospitalm + dist_historicm, # external / amenities
                   data = cleaned_props)

summary(mult_reg_int)

```

Scaling all numeric variables to directly compare effect sizes.

```{r prop_mult_reg_scaled}
scaled_vars <- cleaned_props %>% 
  select(log_price, dist_to_closest_highwaym, total_area, year_built, dist_parkm, dist_libm, dist_cityhallm, dist_hospitalm, dist_historicm, zip_code) %>% 
  mutate(across(c(dist_to_closest_highwaym, total_area, year_built, dist_parkm, dist_libm, dist_cityhallm, dist_hospitalm, dist_historicm), scale))

# model with scaled vars and no interactions 
scaled_mult_reg <- lm(log_price ~ dist_to_closest_highwaym + 
                 total_area + year_built + # internal characteristics
                 dist_parkm + dist_libm + dist_cityhallm + dist_hospitalm + dist_historicm + # external / amenities
                 factor(zip_code), # neighborhood effects (via zip code for now)
               data = scaled_vars)

summary(scaled_mult_reg)

# model with scaled vars and interaction between dist to closest highway and ZIP
scaled_mult_reg_int <- lm(log_price ~ dist_to_closest_highwaym * factor(zip_code) + 
                     total_area + year_built + # internal characteristics
                     dist_parkm + dist_libm + dist_cityhallm + dist_hospitalm + dist_historicm, # external / amenities
                   data = scaled_vars)

summary(scaled_mult_reg_int)

```

Here is code from 3/31 (for second presentation). I was doing a lot of feature engineering for the simple model.

```{r i676effects_setup}
# keep properties within 500m of I-676
i676_buff <- st_union(st_buffer(philly_highways %>% 
                                  filter(ST_RT_NO == "0676"),
                                buff500))

# add features for simple linear regression
properties_i676 <- prop500[i676_buff,] %>% # with this definition, we have 353 properties
  # some feature engineering
  mutate(residential = ifelse(category_code_description %in% c("APARTMENTS  > 4 UNITS",
                                                               "MIXED USE",
                                                               "MULTI FAMILY",
                                                               "SINGLE FAMILY",
                                                               "GARAGE - RESIDENTIAL"),
                              1, 0), # is this property residential? (including mixed)
         
         year_built = as.numeric(year_built),
         year_built_group = case_when(
           is.na(year_built) | year_built < 1990 ~ "Pre-90s",
           year_built >= 1990 & year_built < 2000 ~ "90s",
           year_built >= 2000 & year_built < 2010 ~ "00s",
           year_built >= 2010 & year_built < 2020 ~ "10s",
           year_built >= 2020 ~ "20s"
           ),
         
         log_dist_i676 = log(dist_to_I676),
         
         central_air = case_when(
           central_air %in% c("1", "Y") ~ "Y",  
           TRUE ~ "N"
           ),
         central_air = factor(central_air),
         
         exterior_condition = case_when(
           exterior_condition %in% c("1","2", "3", "4") ~ "AboveAverage",
           exterior_condition == "5" ~ "Average",
           exterior_condition %in% c("6","8","9") ~ "BelowAverage",
           .default = "NAorVacant"
           ),
         exterior_condition = factor(exterior_condition),
         
         interior_condition = case_when(
           interior_condition %in% c("1","2","3") ~ "AboveAverage",
           interior_condition == "4" ~ "Average",
           interior_condition %in% c("5","7") ~ "BelowAverage",
           .default = "NAorVacant"
         ),
         interior_condition = factor(interior_condition),
         
         garage_spaces = case_when(
           is.na(garage_spaces) | garage_spaces == 0 ~ "0",    
           garage_spaces == 1 ~ "1",      
           .default = "2orMore"
         ),
         garage_spaces = factor(garage_spaces),
         
         number_of_bathrooms = case_when(
           number_of_bathrooms == 1 ~ "1",
           number_of_bathrooms == 2 ~ "2",
           number_of_bathrooms > 2 ~ "3orMore",
           .default = "0" # NA or 0
           ),
         number_of_bathrooms = factor(number_of_bathrooms),
    
         number_of_bedrooms = case_when(
           number_of_bedrooms >= 3 ~ "3orMore",
           is.na(number_of_bedrooms) ~ "0",
           .default = as.character(number_of_bedrooms)
         ),
         number_of_bedrooms = factor(number_of_bedrooms),
         
         quality_grade_recoded = case_when(
           quality_grade %in% c("X", "X-", "X ") ~ "HighestQuality",
           quality_grade %in% c("A+", "A", "A ", "A-", "1", "2") ~ "HigherQuality",
           quality_grade %in% c("B+", "B", "B ", "B-", "3", "4") ~ "AverageQuality",
           quality_grade %in% c("S+", "S", "C+", "5", "6") ~ "LowerQuality",
           .default = "LowestQuality" # all lower grades + missing data
         ),
         quality_grade_recoded = factor(quality_grade_recoded),
         
         separate_utilities = factor(separate_utilities),
         
         building_code_description_new = case_when(
           grepl("GYM", building_code_description_new) ~ "GYM",
           grepl("^WARE", building_code_description_new) ~ "WAREHOUSE",
           grepl("COLLEGE|SCHOOL", building_code_description_new) ~ "SCHOOL/COLLEGE/UNI",
           grepl("ROW MIXED", building_code_description_new) ~ "ROWHOME MIXED",
           grepl("TWIN MIXED", building_code_description_new) ~ "TWIN MIXED",
           grepl("^ROW|^TWIN|CONDO|AS RESID", building_code_description_new) ~ "ROW/TWIN/CONDO", # apt blt as resid
           grepl("BOARDING|SNGL", building_code_description_new) ~ "BOARDING/ROOMING/SNGL OCC",
           grepl("MEDICAL", building_code_description_new) ~ "MEDICAL OFFICE",
           grepl("FRAT", building_code_description_new) ~ "BOARDING/ROOMING/SNGL OCC",
           grepl("LOW RISE", building_code_description_new, ignore.case = T) ~ "LOW RISE BLDG",
           grepl("MID RISE", building_code_description_new) ~ "MID RISE APT",
           grepl("HIGH RISE", building_code_description_new) ~ "HIGH RISE APT",
           grepl("PARKING", building_code_description_new) ~ "PARKING",
           grepl("BAR/", building_code_description_new) ~ building_code_description_new, # unchanged names
           grepl("LEGIT", building_code_description_new) ~ building_code_description_new, # unchanged names
           grepl("DIALYSI", building_code_description_new) ~ building_code_description_new, # unchanged names
           grepl("OFFICE WA", building_code_description_new) ~ building_code_description_new, # unchanged names
           grepl("CONV FOOD", building_code_description_new) ~ building_code_description_new, # unchanged names
           grepl("MANUFACTU", building_code_description_new) ~ building_code_description_new, # unchanged names
           .default = "OTHER" # including missing
         ),
         building_code_description_new = factor(building_code_description_new),
      
         zoning_group = case_when(
           zoning %in% c("CMX2.5", "CMX2", "CMX1") ~ "Nghbrhd Commercial Mixed",
           zoning %in% c("CMX3", "CMX4") ~ "Cmmnty Commercial Mixed",
           zoning == "CMX5" ~ "CC Commercial Mixed",
           zoning == "RM1" ~ "Resid MultiFam-Big",
           zoning == "RM4" ~ "Resid MultiFam-Small", 
           zoning == "RMX3" ~ "Resid Mixed", 
           grepl("RSA", zoning) ~ "Resid SnglFam Attached", 
           zoning == "RTA1" ~ "Resid 2Fam Attached", 
           zoning == "IRMX" ~ "Indstrl Resid Mixed", 
           .default = "Other" # including missing
           )
) %>% 
  select(   # only keep vars necessary for model
    log_price,
    dist_to_I676m, log_dist_i676,
    residential, 
    year_built, 
    central_air, garage_spaces, separate_utilities,
    number_of_bathrooms, number_of_bedrooms, total_area,
    exterior_condition, interior_condition, quality_grade_recoded,
    building_code_description_new, zoning_group,
    zip_code
  )

# need to check which of residential, building_code_description_new, or zoning is the best in this model
# also need to check if turning some of the numeric variables into categorical is better (year_built may benefit from this)

# map to visualize
# ggplot() +
#   geom_sf(data = philly_bounds, fill = "#c9b887", color = "grey") +
#   geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
#   geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
#   geom_sf(data = i676_buff,
#           color = "transparent", fill = "grey", alpha = 0.4) +
#   geom_sf(data = propi676_500, size = 0.3, color = "#7fe3d6",
#           show.legend = F) +
#   geom_sf(data = philly_highways %>% 
#             filter(ST_RT_NO == "0676"),
#           color = "black") +
#   labs(title = "Properties within 500m of I-676") +
#   theme_void()


```

```{r i676effects_featureExploration}
# Numeric variables
# number_of_rooms was previously included but all but 10 values are NA
# propi676_500_numvars <- propi676_500 %>% 
#   select(log_price, dist_to_I676m, 
#          # depth, fireplaces, frontage, garage_spaces, number_stories, # ended up excluding
#          number_of_bathrooms,
#          number_of_bedrooms, total_area, year_built) %>% 
#   mutate(year_built = as.numeric(year_built)) %>% 
#   st_drop_geometry()
# 
# cors_logprice <- cor(propi676_500_numvars,
#                      use = "pairwise.complete.obs")
# 
# # significance test 
# # sigtest_logprice <- cor.mtest(propi676_500_numvars)
# 
# # pretty correlation matrix of all continuous variables
# corrplot(cors_logprice, 
#          title = "Correlation Matrix for Log Price",
#          # p.mat = sigtest_logprice$p, 
#          method = 'circle', 
#          type = 'lower', 
#          insig='blank',
#          addCoef.col ='black', 
#          number.cex = 0.8, 
#          diag=FALSE)
# Based off of this correlation matrix, I will move forward with number_of_bathrooms (instead of number_of_bedrooms) since it has a higher correlation with log_price
# total_area will be included (and as a result, I won't keep frontage, depth, and number_of_stories because of multicollinearity)

# Categorical variables

## Basements
# not including because there isn't enough of a difference in log price across categories
# unique(propi676_500$basements)
# table(propi676_500$basements)
# summary(propi676_500$basements)
# 
# temp <- propi676_500 %>% 
#   mutate(basement_finish = case_when(basements %in% c("A", "B", "E", "F") ~ "Finished", # including finished and semi-finished
#                                      basements %in% c("C", "G", "J") ~ "Unfinished",
#                                      basements == "0" ~ "No Basement",
#                                      .default = "Unknown Finish"),
#          basement_size = case_when(basements %in% c("A", "B", "C", "D") ~ "Full", # including finished and semi-finished
#                                    basements %in% c("E", "F", "G", "H") ~ "Partial",
#                                    basements == "0" ~ "No Basement",
#                                    .default = "Unknown Size"))
# 
# ggplot(data = temp %>% 
#          group_by(basement_finish) %>% 
#          summarize(mean_price = mean(adjusted_sale_price),
#                    mean_logprice = mean(log_price)) %>% 
#          ungroup() %>% 
#          pivot_longer(cols = 2:3, names_to = "price_type", values_to = "mean_price"),
#        aes(x = basement_finish, y = mean_price)) +
#   geom_bar(stat = "identity", fill = "#1a9988", alpha = 0.8, width = 0.3) +
#   facet_wrap(~price_type, scales = "free") +
#   theme_minimal() +
#   labs(title = "Mean Property Price (raw and log-transformed) for Different Basement Finishes",
#        x = "Basement Finishes",
#        y = "Mean Price")
# 
# ggplot(data = temp %>% 
#          group_by(basement_size) %>% 
#          summarize(mean_price = mean(adjusted_sale_price),
#                    mean_logprice = mean(log_price)) %>% 
#          ungroup() %>% 
#          pivot_longer(cols = 2:3, names_to = "price_type", values_to = "mean_price"),
#        aes(x = basement_size, y = mean_price)) +
#   geom_bar(stat = "identity", fill = "#1a9988", alpha = 0.8, width = 0.3) +
#   facet_wrap(~price_type, scales = "free") +
#   theme_minimal() +
#   labs(title = "Mean Property Price (raw and log-transformed) for Different Basement Size",
#        x = "Basement Size",
#        y = "Mean Price")

## Category Code
# only including whether a property is residential or not
# unique(propi676_500$category_code)
# table(propi676_500$category_code)
# summary(propi676_500$category_code)
# 
# temp <- propi676_500 %>% 
#   mutate(category_simple = case_when(category_code_description %in% c("APARTMENTS  > 4 UNITS",
#                                                                       "MIXED USE",
#                                                                       "MULTI FAMILY",
#                                                                       "SINGLE FAMILY") ~ "Residential or Mixed",
#                                      grepl("INDUS", category_code_description) ~ "Industrial",
#                                      grepl("HOTEL", category_code_description) ~ "Hotel",
#                                      grepl("OFFICES", category_code_description) ~ "Offices",
#                                      category_code_description %in% c("COMMERCIAL",
#                                                                       "GARAGE - COMMERCIAL",
#                                                                       "RETAIL") ~ "Commercial",
#                                      grepl("VACANT", category_code_description) ~ "Vacant",
#                                      .default = "Other"),
#          residential = ifelse(category_simple == "Residential or Mixed", 1, 0))

# ggplot(data = temp %>% 
#          group_by(category_simple) %>% 
#          summarize(mean_price = mean(adjusted_sale_price),
#                    mean_logprice = mean(log_price)) %>% 
#          ungroup() %>% 
#          pivot_longer(cols = 2:3, names_to = "price_type", values_to = "mean_price"),
#        aes(x = category_simple, y = mean_price)) +
#   geom_bar(stat = "identity", fill = "#1a9988", alpha = 0.8, width = 0.3) +
#   facet_wrap(~price_type, scales = "free") +
#   theme_minimal() +
#   labs(title = "Mean Property Price (raw and log-transformed) by Category",
#        x = "Property Category",
#        y = "Mean Price")

# ggplot(data = temp %>% 
#          group_by(residential) %>% 
#          summarize(mean_price = mean(adjusted_sale_price),
#                    mean_logprice = mean(log_price)) %>% 
#          ungroup() %>% 
#          pivot_longer(cols = 2:3, names_to = "price_type", values_to = "mean_price"),
#        aes(x = residential, y = mean_price)) +
#   geom_bar(stat = "identity", fill = "#1a9988", alpha = 0.8, width = 0.3) +
#   facet_wrap(~price_type, scales = "free") +
#   theme_minimal() +
#   labs(title = "Mean Property Price (raw and log-transformed) by Category (Residential or not)",
#        x = "Property Category",
#        y = "Mean Price")

## Central Air
# not including because there isn't enough of a difference in log price across categories
# unique(propi676_500$central_air)
# table(propi676_500$central_air)
# summary(propi676_500$central_air)
# 
# temp <- propi676_500 %>% 
#   mutate(central_air_new = case_when(central_air == "Y" ~ central_air, 
#                                      .default = "N or unknown"))
# 
# ggplot(data = temp %>%
#          group_by(central_air_new) %>%
#          summarize(mean_price = mean(adjusted_sale_price),
#                    mean_logprice = mean(log_price)) %>%
#          ungroup() %>%
#          pivot_longer(cols = 2:3, names_to = "price_type", values_to = "mean_price"),
#        aes(x = central_air_new, y = mean_price)) +
#   geom_bar(stat = "identity", fill = "#1a9988", alpha = 0.8, width = 0.3) +
#   facet_wrap(~price_type, scales = "free") +
#   theme_minimal() +
#   labs(title = "Mean Property Price (raw and log-transformed) by Central Air",
#        x = "Central Air",
#        y = "Mean Price")

# parcel_shape
# three categories (A,B,E) seem to be good enough
# propi676_500 %>% 
#     select(parcel_shape, adjusted_sale_price, log_price) %>% 
#     st_drop_geometry() %>% 
#     group_by(parcel_shape) %>% 
#     summarize(mean_price = mean(adjusted_sale_price),
#               mean_logprice = mean(log_price)) %>% 
#     ungroup() %>% 
#     pivot_longer(cols = 2:3, names_to = "price_type", values_to = "mean_price") %>% 
#     ggplot(aes(x = parcel_shape, y = mean_price)) +
#     geom_bar(stat = "identity", fill = "#1a9988", alpha = 0.8, width = 0.3) +
#     facet_wrap(~price_type, scales = "free") +
#     theme_minimal() +
#     theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# separate_utilities
# four categories (A,B,C,NA) seem to be good enough
# propi676_500 %>% 
#     select(separate_utilities, adjusted_sale_price, log_price) %>% 
#     st_drop_geometry() %>% 
#     group_by(separate_utilities) %>% 
#     summarize(mean_price = mean(adjusted_sale_price),
#               mean_logprice = mean(log_price)) %>% 
#     ungroup() %>% 
#     pivot_longer(cols = 2:3, names_to = "price_type", values_to = "mean_price") %>% 
#     ggplot(aes(x = separate_utilities, y = mean_price)) +
#     geom_bar(stat = "identity", fill = "#1a9988", alpha = 0.8, width = 0.3) +
#     facet_wrap(~price_type, scales = "free") +
#     theme_minimal() +
#     theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# fireplaces
# not a huge factor, so not including in model for now
# but if i were to use this, i think i would just group this into a binary indicating the presence of a fireplace on a property
# unique(propi676_500$fireplaces)
# table(propi676_500$fireplaces)
# summary(propi676_500$fireplaces)
# 
# propi676_500 %>% 
#   select(fireplaces, adjusted_sale_price, log_price) %>% 
#   st_drop_geometry() %>%
#   group_by(fireplaces) %>%
#   summarize(mean_price = mean(adjusted_sale_price),
#             mean_logprice = mean(log_price)) %>%
#   ungroup() %>%
#   pivot_longer(cols = 2:3, names_to = "price_type", values_to = "mean_price") %>%
#   ggplot(aes(x = fireplaces, y = mean_price)) +
#   geom_bar(stat = "identity", fill = "#1a9988", alpha = 0.8, width = 0.3) +
#   facet_wrap(~price_type, scales = "free") +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# i realized halfway through doing this that I could use what Sijia started with
```


```{r RMSE_calculator}
getRMSE <- function(model_results) {
  # residual sum of squares
  rss <- c(crossprod(model_results$residuals))
  # Mean squared error:
  mse <- rss / length(model_results$residuals)
  # Root MSE:
  RMSE <- sqrt(mse)
  
  return(RMSE)
}

```


```{r i676effects_model1}
# model with just distance to highway
model_i676 <- lm(log_price ~ dist_to_I676m,
                 data = propi676_500)

model_i676_summary <- summary(model_i676)
model_i676_summary
model_i676_RMSE <- getRMSE(model_i676)

```

From a overly simple model, just looking at how distance to I676 (m) predicts property price (log transformed), we see that for properties within 500m of I676, distance from the highway does not have a large effect on property price. We see that for every additional meter away from I676, property price decreases by `r abs(round(exp(model_i676_summary$coefficients[2]) - 1, 3)*100)`% (basically a null effect). The R squared value of the model is very low at `r round(model_i676_summary$r.squared, 3)` and the RMSE is very high `r round(model_i676_RMSE,3)`, meaning the model is terrible.

```{r i676effects_model2}
# model with just distance to highway + zip code
model_i676_zip <- lm(log_price ~ dist_to_I676m + zip_code,
                     data = propi676_500)

model_i676_zip_summary <- summary(model_i676_zip)
model_i676_zip_RMSE <- getRMSE(model_i676_zip)
model_i676_zip_summary

```

When we add ZIP code to this simple model, the adjusted R squared increases to `r round(model_i676_zip_summary$adj.r.squared, 3)` and RMSE decreases to `r round(model_i676_zip_RMSE,3)`, indicating that we have a slightly better, but still bad model. In this ZIP + distance to I676 model, keeping all else constant property price still decreases only by `r abs(round(exp(model_i676_zip_summary$coefficients[2]) - 1, 3)*100)`% per every additional meter away from the expressway.

```{r i676effects_model3}
# simple model but with more predictors
model_i676_more <- lm(log_price ~ dist_to_I676m + 
                        residential + # internal characteristics
                        year_built + central_air + 
                        number_of_bathrooms + total_area +
                        quality_grade_recoded + 
                        factor(zip_code), # neighborhood effects (via zip code for now)
                      data = propi676_500)

model_i676_more_summary <- summary(model_i676_more)
model_i676_more_RMSE <- getRMSE(model_i676_more)
model_i676_more_summary

```

Finally, we look at a more robust model (which is still relatively simple, including only internal features of the property in addition to ZIP code and distance to I676). This model includes the following predictors: year_built (categorical), quality_grade (categorical), number_of_bathrooms (categorical), total_area (continuous), central_air (binary), and a variable dictating whether the property is residential or not (binary). This more complex model does a better job at explaining the variance in property price than our previous two models, but is not optimal either. The adjusted R squared for this model is `r round(model_i676_more_summary$adj.r.squared, 3)` and our RMSE is `r round(model_i676_more_RMSE,3)`. When including these other predictors, the effect of distance to highway is not only much smaller than before, but is now also not statistically significant.

We move forward with our analyses with the hypothesis that although distance to I676 does not play as much of a role in predicting property price, the Chinatown Stitch project will create an open green space that we can conceptualize as a park. We predict that the Chinatown Stitch cap as a park will have a statistically significant effect on property prices nearby.



# Relationship between Housing Price and other variables

First, I filtered the property data in the following ways.

-   Keep properties whose sale date is between Jan. 1st, 2020 - Dec.31st, 2024

-   Adjust sales prices for inflation

-   Remove properties whose sale price is < \$30,000 and > 5 SD from the mean sale price

-   Remove properties whose total area is < 100 sq. ft.

Then, I calculated each property's distance to the four highways of interest as well as amenities. The amenities that we've looked into so far are parks, libraries, transit stops, schools, City Hall (proxy for the central business district), hospitals, museums, and historic sites. We also included distance to prisons as a disamenity.

We still need to look at sale price's relationship with restaurants and grocery stores (I just need to figure out how to use the google API to do this).



```{r cleaned_prop_plots}
# plot of log_price_perTA
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
    geom_sf(data = cleaned_props, aes(color = log_price_perTA), size = 0.2) +
  scale_color_gradient(high = "#eb5600",
                       low = "#f7cfb7") +
  labs(title = "Property Price (log sale price per total area)",
       color = "Log Price") +
  theme_void()


```

I'm going to go through the following columns of interest (amenity predictors) and make a map + scatterplot and get the Pearson correlation coefficient between the amenity/disamenity + sale price (log_price + log_price_perTA).

-   dist_to_closest_highwaym

-   dist_parkm

-   dist_libm

-   dist_transitm

-   dist_schoolm

-   dist_cityhallm

-   dist_hospitalm

-   dist_museumm

-   dist_prisonm

-   dist_historicm

```{r keep_vars_of_interest}
# only keeping two outcomes (log_price + log_price_perTA) and all amenities
vars_of_int <- cleaned_props %>% 
  select(log_price, log_price_perTA, 
         dist_to_closest_highwaym, dist_parkm, dist_libm, dist_transitm, dist_schoolm, dist_cityhallm, dist_hospitalm, dist_museumm, dist_prisonm, dist_historicm)
```

```{r corplot_amenities}
# cor matrix for corplot
cors_logprice <- cor(vars_of_int %>% 
                       select(-log_price_perTA) %>% 
                       rename(dist_2clssthghwy = dist_to_closest_highwaym) %>% 
                       st_drop_geometry())

cors_logpriceperTA <- cor(vars_of_int %>% 
                            select(-log_price) %>% 
                            rename(dist_2clssthghwy = dist_to_closest_highwaym) %>% 
                            st_drop_geometry())

# significance test 
sigtest_logprice <- cor.mtest(vars_of_int %>% 
                                select(-log_price_perTA) %>% 
                                rename(dist_2clssthghwy = dist_to_closest_highwaym) %>% 
                                st_drop_geometry())

sigtest_logpriceperTA <- cor.mtest(vars_of_int %>% 
                                     select(-log_price) %>% 
                                     rename(dist_2clssthghwy = dist_to_closest_highwaym) %>% 
                                     st_drop_geometry())

# pretty correlation matrix of all continuous variables
corrplot(cors_logprice, 
         title = "Correlation Matrix for Log Price",
         p.mat = sigtest_logprice$p, 
         method = 'circle', 
         type = 'lower', 
         insig='blank',
         addCoef.col ='black', 
         number.cex = 0.8, 
         diag=FALSE)

corrplot(cors_logpriceperTA, 
         title = "Correlation Matrix for Log Price",
         p.mat = sigtest_logpriceperTA$p, 
         method = 'circle', 
         type = 'lower', 
         insig='blank',
         addCoef.col ='black', 
         number.cex = 0.8, 
         diag=FALSE)


```

From the correlation matrix, we can see that distance to City Hall, distance to Transit, and distance to museums are all highly collinear with correlation coefficients ranging from .78 (transit and museum) to .98 (museum and city hall). Interestingly, distance to city hall and distance to museum are the variables with the correlation coefficient of highest magnitude with log_price_perTA (at -.38 and -.34 respectively), but distance to transit is not as correlated to the outcome variable (-.18).

When considering all properties in Philadelphia (after cleaning this data a bit), we see that distance to closest highway now has a negative relationship with property sale price (-0.18).


I'm moving forward with log_price_perTA as outcome for now because the size of the property explains a lot of the variance in property sale price already and right now we are focused on external predictors.


### Distance to Parks

```{r dist_park}
dat <- vars_of_int %>% 
  select(log_price_perTA, dist_parkm)

scat_title <- "Log Price (per total area) as a function of Distance to nearest Park"

cor_toplot <- round(cor(dat$dist_parkm, dat$log_price_perTA), 3)

# scatter
ggplot(dat,
       aes(x = dist_parkm,
           y = log_price_perTA)) +
  geom_point(size = 0.2, alpha = 0.3, color = "#1a9988") +
  geom_smooth(method = "lm", color = "#eb5600", fill = "#eba075") +
  geom_text(aes(label = cor_toplot,
                x = 2000,
                y = 10,
                color = "#eb5600"),
            show.legend = F) +
  labs(title = scat_title,
       x = "Distance to nearest Park (m)",
       y = "Log Price (per total area)") +
  theme_minimal()

# map
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = dat, size = 0.2,
          aes(color = dist_parkm)) +
  scale_color_gradient(high = "#f7cfb7",
                       low = "#eb5600") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent", alpha = 0.75) +
  labs(title = "Distance to nearest park",
       color = "Dist. to park") +
  theme_void()

```
Looking at distance to park without the extreme outlier that is almost 2500m from the nearest park
```{r dist_park_no_outlier}
dat <- vars_of_int %>% 
  select(log_price_perTA, dist_parkm) %>% 
  filter(dist_parkm < 2000)

scat_title <- "Log Price (per total area) as a function of Distance to nearest Park"

cor_toplot <- round(cor(dat$dist_parkm, dat$log_price_perTA), 3)

# scatter
ggplot(dat,
       aes(x = dist_parkm,
           y = log_price_perTA)) +
  geom_point(size = 0.2, alpha = 0.3, color = "#1a9988") +
  geom_smooth(method = "lm", color = "#eb5600", fill = "#eba075") +
  geom_text(aes(label = cor_toplot,
                x = 1500,
                y = 10,
                color = "#eb5600"),
            show.legend = F) +
  labs(title = scat_title,
       subtitle = "Removed outlier",
       x = "Distance to nearest Park (m)",
       y = "Log Price (per total area)") +
  theme_minimal()


```
Removing the outlier had no effect on the correlation.

### Distance to Libraries

```{r dist_lib}
dat <- vars_of_int %>% 
  select(log_price_perTA, dist_libm)

scat_title <- "Log Price (per total area) as a function of Distance to nearest Library"

cor_toplot <- round(cor(dat$dist_libm, dat$log_price_perTA), 3)

# scatter
ggplot(dat,
       aes(x = dist_libm,
           y = log_price_perTA)) +
  geom_point(size = 0.2, alpha = 0.3, color = "#1a9988") +
  geom_smooth(method = "lm", color = "#eb5600", fill = "#eba075") +
  geom_text(aes(label = cor_toplot,
                x = 3000,
                y = 10,
                color = "#eb5600"),
            show.legend = F) +
  labs(title = scat_title,
       x = "Distance to nearest Library (m)",
       y = "Log Price (per total area)") +
  theme_minimal()

# map
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = dat, size = 0.2,
          aes(color = dist_libm)) +
  geom_sf(data = libraries, color = "#faef73") +
  scale_color_gradient(high = "#f7cfb7",
                       low = "#eb5600") +
  labs(title = "Distance to nearest Library",
       color = "Dist. to Lib.") +
  theme_void()

```

### Distance to Transit

```{r dist_transit}
dat <- vars_of_int %>% 
  select(log_price_perTA, dist_transitm)

scat_title <- "Log Price (per total area) as a function of Distance to nearest Transit Stop"

cor_toplot <- round(cor(dat$dist_transitm, dat$log_price_perTA), 3)

# scatter
ggplot(dat,
       aes(x = dist_transitm,
           y = log_price_perTA)) +
  geom_point(size = 0.2, alpha = 0.3, color = "#1a9988") +
  geom_smooth(method = "lm", color = "#eb5600", fill = "#eba075") +
  geom_text(aes(label = cor_toplot,
                x = 10000,
                y = 10,
                color = "#eb5600"),
            show.legend = F) +
  labs(title = scat_title,
       x = "Distance to nearest Transit Stop (m)",
       y = "Log Price (per total area)") +
  theme_minimal()

# map
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = dat, size = 0.2,
          aes(color = dist_transitm)) +
  geom_sf(data = transit, color = "#faef73") +
  scale_color_gradient(high = "#f7cfb7",
                       low = "#eb5600") +
  labs(title = "Distance to nearest Transit stop",
       color = "Dist. to station") +
  theme_void()

```

### Distance to Schools

```{r dist_school}
dat <- vars_of_int %>% 
  select(log_price_perTA, dist_schoolm)

scat_title <- "Log Price (per total area) as a function of Distance to nearest School"

cor_toplot <- round(cor(dat$dist_schoolm, dat$log_price_perTA), 3)

# scatter
ggplot(dat,
       aes(x = dist_schoolm,
           y = log_price_perTA)) +
  geom_point(size = 0.2, alpha = 0.3, color = "#1a9988") +
  geom_smooth(method = "lm", color = "#eb5600", fill = "#eba075") +
  geom_text(aes(label = cor_toplot,
                x = 2000,
                y = 10,
                color = "#eb5600"),
            show.legend = F) +
  labs(title = scat_title,
       x = "Distance to nearest School (m)",
       y = "Log Price (per total area)") +
  theme_minimal()

# map
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = dat, size = 0.2,
          aes(color = dist_schoolm)) +
  geom_sf(data = school, color = "#faef73") +
  scale_color_gradient(high = "#f7cfb7",
                       low = "#eb5600") +
  labs(title = "Distance to nearest School",
       color = "Dist. to School") +
  theme_void()

```

### Distance to City Hall

```{r dist_cityhall}
dat <- vars_of_int %>% 
  select(log_price_perTA, dist_cityhallm)

scat_title <- "Log Price (per total area) as a function of Distance to City Hall"

cor_toplot <- round(cor(dat$dist_cityhallm, dat$log_price_perTA), 3)

# scatter
ggplot(dat,
       aes(x = dist_cityhallm,
           y = log_price_perTA)) +
  geom_point(size = 0.2, alpha = 0.3, color = "#1a9988") +
  geom_smooth(method = "lm", color = "#eb5600", fill = "#eba075") +
  geom_text(aes(label = cor_toplot,
                x = 20000,
                y = 10,
                color = "#eb5600"),
            show.legend = F) +
  labs(title = scat_title,
       x = "Distance to City Hall (m)",
       y = "Log Price (per total area)") +
  theme_minimal()

# map
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = dat, size = 0.2,
          aes(color = dist_cityhallm)) +
  geom_sf(data = city_hall, color = "#faef73") +
  scale_color_gradient(high = "#f7cfb7",
                       low = "#eb5600") +
  labs(title = "Distance to City Hall",
       color = "Dist. to CH") +
  theme_void()

```

### Distance to Hospitals

```{r dist_hospital}
dat <- vars_of_int %>% 
  select(log_price_perTA, dist_hospitalm)

scat_title <- "Log Price (per total area) as a function of Distance to nearest Hospital"

cor_toplot <- round(cor(dat$dist_hospitalm, dat$log_price_perTA), 3)

# scatter
ggplot(dat,
       aes(x = dist_hospitalm,
           y = log_price_perTA)) +
  geom_point(size = 0.2, alpha = 0.3, color = "#1a9988") +
  geom_smooth(method = "lm", color = "#eb5600", fill = "#eba075") +
  geom_text(aes(label = cor_toplot,
                x = 5000,
                y = 10,
                color = "#eb5600"),
            show.legend = F) +
  labs(title = scat_title,
       x = "Distance to nearest Hospital (m)",
       y = "Log Price (per total area)") +
  theme_minimal()

# map
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = dat, size = 0.2,
          aes(color = dist_hospitalm)) +
  geom_sf(data = hospitals, color = "#faef73") +
  scale_color_gradient(high = "#f7cfb7",
                       low = "#eb5600") +
  labs(title = "Distance to nearest Hospital",
       color = "Dist. to Hospital") +
  theme_void()

```

### Distance to Museums

```{r dist_museum}
dat <- vars_of_int %>% 
  select(log_price_perTA, dist_museumm)

scat_title <- "Log Price (per total area) as a function of Distance to nearest Museum"

cor_toplot <- round(cor(dat$dist_museumm, dat$log_price_perTA), 3)

# scatter
ggplot(dat,
       aes(x = dist_museumm,
           y = log_price_perTA)) +
  geom_point(size = 0.2, alpha = 0.3, color = "#1a9988") +
  geom_smooth(method = "lm", color = "#eb5600", fill = "#eba075") +
  geom_text(aes(label = cor_toplot,
                x = 15000,
                y = 10,
                color = "#eb5600"),
            show.legend = F) +
  labs(title = scat_title,
       x = "Distance to nearest Museum (m)",
       y = "Log Price (per total area)") +
  theme_minimal()

# map
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = dat, size = 0.2,
          aes(color = dist_museumm)) +
  geom_sf(data = museums, color = "#faef73") +
  scale_color_gradient(high = "#f7cfb7",
                       low = "#eb5600") +
  labs(title = "Distance to nearest Museum",
       color = "Dist. to Museum") +
  theme_void()

```

### Distance to Prisons

```{r dist_prison}
dat <- vars_of_int %>% 
  select(log_price_perTA, dist_prisonm)

scat_title <- "Log Price (per total area) as a function of Distance to nearest Prison"

cor_toplot <- round(cor(dat$dist_prisonm, dat$log_price_perTA), 3)

# scatter
ggplot(dat,
       aes(x = dist_prisonm,
           y = log_price_perTA)) +
  geom_point(size = 0.2, alpha = 0.3, color = "#1a9988") +
  geom_smooth(method = "lm", color = "#eb5600", fill = "#eba075") +
  geom_text(aes(label = cor_toplot,
                x = 9000,
                y = 10,
                color = "#eb5600"),
            show.legend = F) +
  labs(title = scat_title,
       x = "Distance to nearest Prison (m)",
       y = "Log Price (per total area)") +
  theme_minimal()

# map
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = dat, size = 0.2,
          aes(color = dist_prisonm)) +
  geom_sf(data = prisons, color = "#faef73") +
  scale_color_gradient(high = "#f7cfb7",
                       low = "#eb5600") +
  labs(title = "Distance to nearest Prison",
       color = "Dist. to Prison") +
  theme_void()

```

### Distance to Historic Site

```{r dist_hist}
dat <- vars_of_int %>% 
  select(log_price_perTA, dist_historicm)

scat_title <- "Log Price (per total area) as a function of Distance to nearest Historic Site"

cor_toplot <- round(cor(dat$dist_historicm, dat$log_price_perTA), 3)

# scatter
ggplot(dat,
       aes(x = dist_historicm,
           y = log_price_perTA)) +
  geom_point(size = 0.2, alpha = 0.3, color = "#1a9988") +
  geom_smooth(method = "lm", color = "#eb5600", fill = "#eba075") +
  geom_text(aes(label = cor_toplot,
                x = 6000,
                y = 10,
                color = "#eb5600"),
            show.legend = F) +
  labs(title = scat_title,
       x = "Distance to nearest Historic Site (m)",
       y = "Log Price (per total area)") +
  theme_minimal()

# map
ggplot() +
  geom_sf(data = philly_bounds, fill = "#c9b887") +
  geom_sf(data = hydro, fill = "#7d97c7", color = "transparent") +
  geom_sf(data = philly_parks, fill = "#6b9169", color = "transparent") +
  geom_sf(data = dat, size = 0.2,
          aes(color = dist_historicm)) +
  geom_sf(data = historic, color = "#faef73") +
  scale_color_gradient(high = "#f7cfb7",
                       low = "#eb5600") +
  labs(title = "Distance to Historic Site",
       color = "Dist. to Hist.") +
  theme_void()

```
